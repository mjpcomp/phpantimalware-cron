#!/bin/bash

# =============================================================================
# - title        : Scan and Report Sender for PHP-Antimalware-Scanner
# - description  : Initiates a PHP-Antimalware-Scanner and sends a report
# - author       : MJPComp
# - date         : 2021-08-30
# - version      : 2021-08-30
# - usage        : bash clamav-cron.sh
# - oses         : Ubuntu,Debian
# =============================================================================
# - fork         : clamav-cron v. 0.8.3 - Copyright 2014, Mark Parraway
# - site         : https://github.com/yangwithinyin/clamav-cron
#
# - fork         : clamav-cron v. 0.6 - Copyright 2009, Stefano Stagnaro
# - site         : https://code.google.com/p/clamav-cron/
#
# This is Free Software released under the GNU GPL license version 3
#
# =============================================================================
#
# Add to crontab, e.g. crontab -e
# 45 23 * * 5 /usr/local/bin/phpantimalware-cron.sh /
#

#============================================#
#        User configuration section          #
#============================================#

# Using Virtualmin Default of /home/website.ext/public_html? Then set this to 1
PHPAS_VIRTUALMIN="1"

# Domain Name or Website Name for report subject
PHPAS_REPORTNAME="website.ext"

# If Using Virtualmin, enter the "website.ext" otherwise, the full path to scan:
PHPAS_SCANPATH="website.ext"

# Log file name and its path, if using Virtualmin, you can use /home/$PHPAS_SCANPATH/logs/$PHPAS_SCANPATH.log
#CV_LOGFILE="$HOME/clamav-cron.log"
PHPAS_LOGFILE="/home/$PHPAS_SCANPATH/logs/$PHPAS_SCANPATH.log"

# Notification e-mail sender:
PHPAS_MAILFROM="phpantimalware@yourserver.net"

# Notification e-mail recipient, separate any additional with semicolons:
PHPAS_MAILTO="user@yourdomain.com"

# Notification e-mail secondary recipients:
# PHPAS_MAILTO_CC="user2@yourdomain.com; user3@otherdomain.org"

# Notification e-mail subject:
PHPAS_SUBJECT="PHP Antimalware Scan report for $PHPAS_REPORTNAME"

#============================================#
#        DO NOT EDIT DO NOT EDIT             #
#============================================#

CV_TARGET="$1"
CV_VERSION_ORIG="0.6"
CV_VERSION_FORK="0.8.3"

if [ -e $CV_LOGFILE ]
then
        /bin/rm $CV_LOGFILE
fi

if [ -z "$1" ]
then
        CV_TARGET="$HOME"
fi

#To be read on stdout (and root mail):
echo -e clamav-cron v. $CV_VERSION_ORIG - Copyright 2009, Stefano Stagnaro '\n'
echo -e `basename $0` v. $CV_VERSION_FORK - Copyright 2014, Mark Parraway '\n'

#To be read on logfile (sent via sendmail):
echo -e $CV_SUBJECT - $(date) '\n' >> $CV_LOGFILE
echo -e Script: clamav-cron v. $CV_VERSION_ORIG - Copyright 2009, Stefano Stagnaro  >> $CV_LOGFILE
echo -e Script: `basename $0` v. $CV_VERSION_FORK - Copyright 2014, by Mark Parraway  >> $CV_LOGFILE
echo -e Scanned: $CV_TARGET on $HOSTNAME'\n' >> $CV_LOGFILE

# /usr/local/bin/stuff may need to be symlinked up
# easy symlink in your OS setup script

/usr/local/bin/freshclam --log=$CV_LOGFILE --user $USER --verbose

#To be read on stdout (and root mail):
echo -e '------------------------------------\n'

/usr/local/bin/clamscan --infected --log=$CV_LOGFILE --recursive $CV_TARGET --exclude=/proc --exclude=/sys --exclude=/dev --exclude=/media --exclude=/mnt
CLAMSCAN=$?

if [ "$CLAMSCAN" -eq "1" ]
then
        CV_SUBJECT="[VIRUS!] "$CV_SUBJECT
        /usr/local/bin/mail -s "$CV_SUBJECT" -c $CV_MAILTO_CC $CV_MAILTO -- -f $CV_MAILFROM < $CV_LOGFILE
elif [ "$CLAMSCAN" -gt "1" ]
then
        CV_SUBJECT="[ERR] "$CV_SUBJECT
        /usr/local/bin/mail -s "$CV_SUBJECT" -c $CV_MAILTO_CC $CV_MAILTO -- -f $CV_MAILFROM < $CV_LOGFILE
fi
